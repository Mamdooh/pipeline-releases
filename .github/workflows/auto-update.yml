name: Auto Update Service Version

on:
  repository_dispatch:
    types: [service-update]

jobs:
  update-version:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq
      
      - name: Get service info
        id: info
        run: |
          echo "service=${{ github.event.client_payload.service }}" >> $GITHUB_OUTPUT
          echo "version=${{ github.event.client_payload.version }}" >> $GITHUB_OUTPUT
          echo "repo=${{ github.event.client_payload.repo }}" >> $GITHUB_OUTPUT
          
          echo "üì¶ Service: ${{ github.event.client_payload.service }}"
          echo "üè∑Ô∏è  Version: ${{ github.event.client_payload.version }}"
      
      - name: Calculate new platform version
        id: calc
        run: |
          CURRENT=$(yq '.platform_version' services.yaml)
          echo "Current platform version: $CURRENT"
          
          # Increment patch version
          IFS='.' read -ra V <<< "$CURRENT"
          MAJOR=${V[0]}
          MINOR=${V[1]}
          PATCH=${V[2]}
          
          NEW_PATCH=$((PATCH + 1))
          NEW_VERSION="$MAJOR.$MINOR.$NEW_PATCH"
          
          echo "New platform version: $NEW_VERSION"
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "current_version=$CURRENT" >> $GITHUB_OUTPUT
      
      - name: Update services.yaml
        run: |
          SERVICE="${{ steps.info.outputs.service }}"
          VERSION="${{ steps.info.outputs.version }}"
          NEW_PLATFORM="${{ steps.calc.outputs.new_version }}"
          
          echo "Updating services.yaml..."
          
          # Update service version
          yq -i ".services.$SERVICE.version = \"$VERSION\"" services.yaml
          
          # Update platform version
          yq -i ".platform_version = \"$NEW_PLATFORM\"" services.yaml
          
          # Update timestamp
          yq -i ".updated = \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"" services.yaml
          
          # Update who updated
          yq -i ".updated_by = \"Auto-update from $SERVICE\"" services.yaml
          
          echo "‚úÖ Updated services.yaml"
          echo ""
          echo "Changes:"
          cat services.yaml
      
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: update ${{ steps.info.outputs.service }} to ${{ steps.info.outputs.version }}"
          title: "Update ${{ steps.info.outputs.service }} to ${{ steps.info.outputs.version }}"
          body: |
            ## üîÑ Service Update
            
            **Service:** `${{ steps.info.outputs.service }}`  
            **New Version:** `${{ steps.info.outputs.version }}`  
            **Repository:** [${{ steps.info.outputs.repo }}](https://github.com/${{ steps.info.outputs.repo }})
            
            ---
            
            ## üìä Platform Version Change
            
            **Previous:** `v${{ steps.calc.outputs.current_version }}`  
            **New:** `v${{ steps.calc.outputs.new_version }}`
            
            ---
            
            ## üîó Links
            
            - [Service Release](https://github.com/${{ steps.info.outputs.repo }}/releases/tag/${{ steps.info.outputs.version }})
            - [Service Repository](https://github.com/${{ steps.info.outputs.repo }})
            
            ---
            
            ## ‚úÖ Checklist
            
            - [ ] Review service changes
            - [ ] Verify version increment is correct
            - [ ] Approve and merge
            
            ---
            
            *ü§ñ Auto-generated by service deployment*
          branch: auto-update-${{ steps.info.outputs.service }}-${{ github.run_number }}
          delete-branch: true
          labels: |
            automated
            service-update
            ${{ steps.info.outputs.service }}
